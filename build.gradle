import org.apache.tools.ant.filters.ReplaceTokens

buildscript {
    repositories {
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id 'nebula.release'
    id 'base'

    id "com.github.hierynomus.license"
    id 'org.ajoberstar.git-publish'
    id "com.github.ben-manes.versions"
    id "io.github.gradle-nexus.publish-plugin"
}

ext {
    groovyVersion = project.findProperty("groovyVersion") ?: '2.4.21'
    // groovyVersion = '4.0.12'
}

group 'com.blackbuild.klum.ast'
description 'A transformation for creating convenient configuration model DSLs.'

nexusPublishing {
    repositories {
        sonatype()
    }
}

gitPublish {
    repoUri = 'git@github.com:klum-dsl/klum-ast.wiki.git'
    branch = 'master'

    contents {
        from 'wiki'
        filesMatching('*.md') {
            filter(ReplaceTokens, tokens: [version: version.toString()])
        }
        from('.') {
            include("CHANGES.md")
            rename('CHANGES.md', "Changelog.md")
        }
    }

    repoDir = file("$buildDir/gitPublish")
    
    commitMessage = "updated wiki for $version"
}

releaseCheck.doLast {
    if (!gradle.includedBuilds.isEmpty())
        throw new GradleException("Releasing is not allowed with composite builds. Please release $gradle.includedBuilds separately")

    if (JavaVersion.current() != JavaVersion.VERSION_11)
        throw new GradleException("Releasing must be done with JDK 11")

    if (!rootProject.ext.groovyVersion.startsWith("2."))
        throw new GradleException("Releasing must be done with Groovy 2.4")
}

evaluationDependsOnChildren()

tasks.candidate.finalizedBy tasks.gitPublishPush
tasks.final.finalizedBy tasks.gitPublishPush

def configurePom(pom, Project module) {
    pom.name = module.name
    pom.description = module.description

    pom.url = 'https://github.com/klum-dsl/klum-ast.git'

    pom.scm {
        url = 'https://github.com/klum-dsl/klum-ast.git'
        connection = 'scm:git:https://github.com/klum-dsl/klum-ast.git'
        developerConnection = 'scm:git:https://github.com/klum-dsl/klum-ast.git'
    }

    pom.licenses {
        license {
            name = 'MIT License (MIT)'
            url = 'https://opensource.org/licenses/MIT'
            distribution = 'repo'
        }
    }

    pom.developers {
        developer {
            id = 'pauxus'
            name = 'Stephan Pauxberger'
            email = 'stephan@blackbuild.com'
            url = 'https://github.com/pauxus'
        }
    }
}
